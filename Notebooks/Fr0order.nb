(* ::Package:: *)

(* ::Input:: *)
(*LaunchKernels[64];*)
(*<<SpinWeightedSpheroidalHarmonics`*)
(*<<KerrGeodesics`*)
(*<<GeneralRelativityTensors`*)
(*<<Teukolsky`*)
(*ParallelNeeds["SpinWeightedSPheroidalHarmonics`"]*)
(*ParallelNeeds["KerrGeodesics`"]*)
(*ParallelNeeds["GeneralRelativityTensors`"]*)
(*ParallelNeeds["Teukolsky`"]*)
(**)
(*\[GothicS][sp_,l_,lp_, m_]:= -sp  Sqrt[(2(2l+1))/(2 lp +1)]ClebschGordan[{l,m},{1,0},{lp,m}] ClebschGordan[{l,-sp} ,{1,sp }, {lp ,0}]*)
(*Ccoef[s_,j_,k_,m_,bs_]:=\[GothicS][s,j,k,m]*(j/.bs);*)
(*CLcoef [a_,m_,n_,j_,k_,\[Omega]_, bs_]:=(j/.bs)*(Sqrt[j(j+1)] KroneckerDelta[j,k] - a \[Omega] \[GothicS][+1, j,k,m]);*)
(**)
(*Fr0[a_,\[Tau]_,  orbit_, k_,m_,n_, LMAX_, JMAX_]:= Module[{t, r,\[Theta],\[CurlyPhi], tdot, phidot,  rmin, rmax},*)
(*{t,r,\[Theta],\[CurlyPhi]}=orbit["Trajectory"];*)
(*rmin = orbit["p"]/(1+orbit["e"]+0.1);*)
(*     rmax = orbit["p"]/(1-orbit["e"]-0.1);*)
(*Sum[Module[{bsplus,bsminus,\[Chi], g, dP, K0,\[CapitalBeta],Pminus, Pplus,Rminus,  \[CapitalDelta], \[Lambda]},*)
(*\[Lambda] = SpinWeightedSpheroidalEigenvalue[-1,l,m,a \[Omega][m,n]];*)
(*\[CapitalBeta]= Sqrt[\[Lambda]^2 + 4 a m \[Omega][m,n] - 4 a^2 \[Omega][m,n]^2];*)
(*K0= \[Omega][m,n](r[\[Tau]] + a^2)- a m;*)
(*bsplus = SpinWeightedSpheroidalHarmonicS[1,l,m,a \[Omega][m,n],Method->{"SphericalExpansion","NumTerms"->6}]["ExpansionCoefficients"] ;*)
(*bsminus = SpinWeightedSpheroidalHarmonicS[-1,l,m,a \[Omega][m,n],Method->{"SphericalExpansion","NumTerms"->6}]["ExpansionCoefficients"] ;*)
(*Rminus=TeukolskyRadial[-1, l,m,a ,\[Omega][m,n],Method->{"NumericalIntegration","Domain"-> {"In"->{rmin,rmax}, "Up"->{rmin,rmax}}}];*)
(*Pminus= Rminus["In"][r[\[Tau]]];*)
(*\[CapitalDelta]=r[\[Tau]]^2-2 M r[\[Tau]] + a^2/.M->1;*)
(*Pplus = \[CapitalDelta] TeukolskyRadial[1,l,m,a,\[Omega][m,n], Method->{"NumericalIntegration","Domain"-> {"In"->{rmin,rmax}, "Up"->{rmin,rmax}}}]["Up"][r[\[Tau]]];*)
(*dP =Rminus["In"]'[r[\[Tau]]];*)
(**)
(*g= 1/\[CapitalBeta] (r[\[Tau]] dP- I K0 r[\[Tau]]/\[CapitalDelta] Pminus-Pminus);*)
(*\[Chi]=Exp[-I \[Omega][m,n] t[\[Tau]] + I m \[CurlyPhi][\[Tau]]];*)
(*(Sqrt[2] (t'[\[Tau]] - a \[CurlyPhi]'[\[Tau]]))/r[\[Tau]]^2 Re[\[Chi](CLcoef[a, m, n ,j,k,\[Omega][m,n],bsplus]g + I a Ccoef[1, j, k, m , bsplus] /\[CapitalBeta])] + (\[CurlyPhi]'[\[Tau]] *(a^2+r[\[Tau]]^2) + a t'[\[Tau]])/(Sqrt[2] \[CapitalDelta] r[\[Tau]]) Im[\[Chi](Ccoef[-1, j,k,m, bsminus]TeukolskyPointParticleMode[-1,l,m,n,0, orbit] ["ExtendedHomogeneous" -> "\[ScriptCapitalH]"][r[\[Tau]]]Pminus - Ccoef[1,j,k,m, bsplus] TeukolskyPointParticleMode[1,l,m,n,0, orbit] ["ExtendedHomogeneous" -> "\[ScriptCapitalH]"][r[\[Tau]]] Pplus)]*)
(**)
(*],{l,Max[1,Abs[m]],LMAX}, {j, Max[1, Abs[m]], JMAX}]*)
(*]*)
(**)
(*ParallelEvaluate[Off[ClebschGordan::tri ]]*)
(*ParallelEvaluate[Off[ClebschGordan::phy]]*)
(**)
(*With[{a=0, e=0.1,p=10,x=1, \[Tau]=0.1,NMax=6},*)
(*q=1;*)
(*orbit = KerrGeoOrbit[a,p,e,x];*)
(*\[CapitalOmega] =KerrGeoFrequencies[a,p,e,x];*)
(*\[Omega][m_,n_]:=m \[CapitalOmega][[3]] + n \[CapitalOmega][[1]];*)
(*kmodes = Table[*)
(*ParallelSum[Fr0[a,\[Tau],  orbit,k ,m,n, NMax, NMax], {m,-NMax,NMax}, {n,-NMax, NMax}],{k,1,5}]*)
(*]*)
(*Export[]*)
